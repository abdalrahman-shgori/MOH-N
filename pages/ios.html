<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://apis.google.com/js/api.js"></script>
    <title>TEST</title>
</head>
<body>

    <button id="button">TEST ADD MULTI EVENTS</button>
    <div id="logs" >

    </div>

    <script>
      window.onload = () => {
      function initClient() {
        gapi.client.init({
          clientId: '831010665054-18pkq0jo07jcl72r3kg1lupei18fc8hl.apps.googleusercontent.com',
          discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
          scope: 'https://www.googleapis.com/auth/calendar.events',
          cookiepolicy: 'single_host_origin',
          plugin_name: 'hello'
        });
      }

    gapi.load('client:auth2', initClient);
    function handleAuthClick() {
      gapi.auth2.getAuthInstance().signIn().then((res) => {
        document.getElementById('button').click();
      })
    }

    // ADD EVETNS FUNCTION
    function generateUid() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}
    function downloadIcsFile(content) {
      document.getElementById('logs').appendChild(document.createTextNode(' / Entered 3 / '))
      const blob = new Blob([content], {type: 'text/calendar;charset=utf-8;'});
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'events.ics';
      document.getElementById('logs').appendChild(document.createTextNode(' / Entered 4 / '))
      link.click();
      document.getElementById('logs').appendChild(document.createTextNode(' / Entered 5 / '))
    }
    function createIcsFile(events) {
    let icsFileContent = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//hacksw/handcal//NONSGML v1.0//EN\n';

    events.forEach(event => {
        icsFileContent += 'BEGIN:VEVENT\n';
        icsFileContent += 'UID:' + generateUid() + '\n';
        icsFileContent += 'DTSTAMP:' + new Date().toISOString().replace(/[-:.]/g, '') + '\n';
        icsFileContent += 'DTSTART:' + event.start.dateTime + '\n';
        icsFileContent += 'DTEND:' + event.end.dateTime + '\n';
        icsFileContent += event.recurrence[0] + '\n';
        icsFileContent += 'SUMMARY:' + event.summary + '\n';
        icsFileContent += 'DESCRIPTION:' + event.description + '\n';
        icsFileContent += 'LOCATION:' + event.location + '\n';
        icsFileContent += 'END:VEVENT\n';
    });

    icsFileContent += 'END:VCALENDAR';

    downloadIcsFile(icsFileContent);
}
    document.getElementById('button').addEventListener('click', function() {
      // dummy events
      var events = [
        {
          'summary': 'Team Meeting',
          'location': 'Online',
          'description': 'Meeting to discuss project status and next steps.',
          'start': {
            'dateTime': '2023-10-01T09:00:00-07:00',
            'timeZone': 'America/Los_Angeles'
          },
          'end': {
            'dateTime': '2023-10-01T10:00:00-07:00',
            'timeZone': 'America/Los_Angeles'
          },
          'recurrence': [
            'RRULE:FREQ=WEEKLY;UNTIL=202311201T000000Z'
          ],
          'attendees': [
            {'email': 'example1@example.com'},
            {'email': 'example2@example.com'}
          ],
          'reminders': {
            'useDefault': false,
            'overrides': [
              {'method': 'email', 'minutes': 24 * 60},
              {'method': 'popup', 'minutes': 10}
            ]
          }
        },
        {
          'summary': 'Team Meeting',
          'location': 'Online',
          'description': 'Meeting to discuss project status and next steps.',
          'start': {
            'dateTime': '2023-10-02T09:00:00-07:00',
            'timeZone': 'America/Los_Angeles'
          },
          'end': {
            'dateTime': '2023-10-02T10:00:00-07:00',
            'timeZone': 'America/Los_Angeles'
          },
          'recurrence': [
            'RRULE:FREQ=WEEKLY;UNTIL=20231202T000000Z'
          ],
          'attendees': [
            {'email': 'example1@example.com'},
            {'email': 'example2@example.com'}
          ],
          'reminders': {
            'useDefault': false,
            'overrides': [
              {'method': 'email', 'minutes': 24 * 60},
              {'method': 'popup', 'minutes': 10}
            ]
          }
        },
      ];

      var platform = navigator.userAgent || navigator.vendor || window.opera;
      // div.innerHTML('Entered ')
      const expression = /(Mac|iPhone|iPod|iPad)/i;
      if (expression.test(navigator.platform)) {
        document.getElementById('logs').appendChild(document.createTextNode(` / Entered 1 / `))
        createIcsFile(events)
        document.getElementById('logs').appendChild(document.createTextNode(' / Entered 2 / '))
          return;
      }

      events.forEach(function(event) {
        gapi.client.calendar.events.insert({
          'calendarId': 'primary',
          'resource': event
        }).then(function(response) {
          console.log('Event created: ' + response.result.htmlLink);
        }).catch((err) => {
            if(err.status == 401){
                handleAuthClick();
            }
            
        })
        ;
      });
    });
}
    </script>
</body>
</html>