<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://apis.google.com/js/api.js"></script>
    <title>TEST</title>
</head>
<body>
    <button id="button">TEST ADD MULTI EVENTS</button>
    <div id="logs"></div>

    <script>
        window.onload = () => {
            // Initialize the Google API client
            function initClient() {
                gapi.client.init({
                    clientId: '831010665054-18pkq0jo07jcl72r3kg1lupei18fc8hl.apps.googleusercontent.com',
                    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
                    scope: 'https://www.googleapis.com/auth/calendar.events',
                    cookiepolicy: 'single_host_origin',
                    plugin_name: 'hello'
                });
            }

            gapi.load('client:auth2', initClient);

            function handleAuthClick() {
                gapi.auth2.getAuthInstance().signIn().then((res) => {
                    document.getElementById('button').click();
                });
            }

            // ADD EVENTS FUNCTION
            function generateUid() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            // Function to create and trigger a download of an .ics file
            function downloadIcsFile(content) {
                // Create a data URI for the .ics content
                const dataUri = "data:text/calendar;charset=utf-8," + encodeURIComponent(content);

                // Create a link element for the download
                const link = document.createElement('a');
                link.href = dataUri;
                link.download = 'events.ics';

                // Trigger the download
                link.click();
            }

            // Function to create an .ics file content
            function createIcsFile(events) {
                let icsFileContent = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//hacksw/handcal//NONSGML v1.0//EN\n';

                events.forEach(event => {
                    icsFileContent += 'BEGIN:VEVENT\n';
                    icsFileContent += 'UID:' + generateUid() + '\n';
                    icsFileContent += 'DTSTAMP:' + new Date().toISOString().replace(/[-:.]/g, '') + '\n';
                    icsFileContent += 'DTSTART:' + event.start.dateTime + '\n';
                    icsFileContent += 'DTEND:' + event.end.dateTime + '\n';
                    icsFileContent += event.recurrence[0] + '\n';
                    icsFileContent += 'SUMMARY:' + event.summary + '\n';
                    icsFileContent += 'DESCRIPTION:' + event.description + '\n';
                    icsFileContent += 'LOCATION:' + event.location + '\n';
                    icsFileContent += 'END:VEVENT\n';
                });

                icsFileContent += 'END:VCALENDAR';

                downloadIcsFile(icsFileContent);
            }

            document.getElementById('button').addEventListener('click', function() {
                // Dummy events
                var events = [
                    // Your event data here
                ];

                var platform = navigator.userAgent || navigator.vendor || window.opera;
                const expression = /(Mac|iPhone|iPod|iPad)/i;

                if (expression.test(navigator.platform)) {
                    // iOS device detected, generate .ics file
                    createIcsFile(events);
                } else {
                    // Non-iOS device, attempt to add events to Google Calendar
                    events.forEach(function(event) {
                        gapi.client.calendar.events.insert({
                            'calendarId': 'primary',
                            'resource': event
                        }).then(function(response) {
                            console.log('Event created: ' + response.result.htmlLink);
                        }).catch((err) => {
                            if (err.status == 401) {
                                handleAuthClick();
                            }
                        });
                    });
                }
            });
        }
    </script>
</body>
</html>
